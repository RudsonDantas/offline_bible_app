var config = require('../../config');

exports = module.exports = function (req, res, next) {
  if (req.auth.error) { return res.redirect(config.urls.app.loginError) };

  if (req.session) {
    if (req.auth.user.error || req.auth.response.statusCode != 200) {
      req.session.requestedUrl = req.originalUrl;
      var redirectUrl = req.protocol + '://' + req.get('Host') + config.urls.app.loginCallback;

      return res.redirect(config.auth.host + config.urls.auth.login + '?redirect_url=' + redirectUrl);
    } else {
      return next();
    }
  } else {
    return res.status(401).json({error: 'unauthorized'});
  }
}
